generator client {
  provider = "prisma-client"
  output   = "../generated/prisma/"
}

datasource db {
  provider = "postgresql"
}

enum AuthProvider {
  discord
  steam
}

enum FrequencyType {
  SR
  LR
}

model User {
  id                Int                @id @default(autoincrement())
  username          String?
  email             String?
  avatarUrl         String?
  isAdmin           Boolean            @default(false)
  createdAt         DateTime           @default(now())
  accounts          AuthAccount[]
  orbats            Orbat[]            @relation("OrbatCreator")
  signups           Signup[]
  orbatTemplates    OrbatTemplate[]
  userTrainings     UserTraining[]
  trainingRequests  TrainingRequest[]
  handledRequests   TrainingRequest[]  @relation("TrainingRequestHandledBy")
}

model AuthAccount {
  id             Int          @id @default(autoincrement())
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         Int
  provider       AuthProvider // Using enum here for clarity
  providerUserId String

  @@unique([provider, providerUserId])
}

model Orbat {
  id               Int       @id @default(autoincrement())
  name             String
  description      String?
  eventDate        DateTime?
  startTime        String?
  endTime          String?
  createdBy        User      @relation("OrbatCreator", fields: [createdById], references: [id])
  createdById      Int
  createdAt        DateTime  @default(now())
  slots            Slot[]
  frequencies      OrbatRadioFrequency[]
  tempFrequencies  Json?     @default("[]") // Store temporary frequencies as JSON array
  // BLUFOR faction
  bluforCountry    String?
  bluforRelationship String?
  // OPFOR faction
  opforCountry     String?
  opforRelationship String?
  // Independent faction
  indepCountry     String?
  indepRelationship String?
  // Extra Intel
  iedThreat        String?   // IED/Trap/Mine Threat
  civilianRelationship String? // Civilian Relationship
  rulesOfEngagement String?  // Rules of Engagement
  airspace         String?   // Airspace
  inGameTimezone   String?   // In Game Timezone
  operationDay     String?   // Operation Day
}

model Slot {
  id         Int       @id @default(autoincrement())
  orbat      Orbat     @relation(fields: [orbatId], references: [id], onDelete: Cascade)
  orbatId    Int
  name       String
  orderIndex Int
  subslots   Subslot[]
}

model Subslot {
  id         Int       @id @default(autoincrement())
  slot       Slot      @relation(fields: [slotId], references: [id], onDelete: Cascade)
  slotId     Int
  name       String
  orderIndex Int
  maxSignups Int       @default(1)
  signups    Signup[]
}

model RadioFrequency {
  id           Int       @id @default(autoincrement())
  frequency    String    @unique // e.g., "70.0"
  type         FrequencyType // SR or LR
  isAdditional Boolean   @default(false) // True for ASR (Additional Short Range), etc
  channel      String?   // e.g., "SR Channel 1", "LR Channel 1"
  callsign     String?   // Optional callsign
  createdAt    DateTime  @default(now())
  orbats       OrbatRadioFrequency[]
}

model OrbatRadioFrequency {
  id              Int      @id @default(autoincrement())
  orbat           Orbat    @relation(fields: [orbatId], references: [id], onDelete: Cascade)
  orbatId         Int
  radioFrequency  RadioFrequency @relation(fields: [radioFrequencyId], references: [id], onDelete: Cascade)
  radioFrequencyId Int

  @@unique([orbatId, radioFrequencyId])
  @@index([orbatId])
}

model Signup {
  id        Int      @id @default(autoincrement())
  subslot   Subslot  @relation(fields: [subslotId], references: [id], onDelete: Cascade)
  subslotId Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  createdAt DateTime @default(now())

  @@unique([subslotId, userId])
  @@index([userId])  // Indexing for fast lookup
}

model OrbatTemplate {
  id                    Int       @id @default(autoincrement())
  name                  String    @unique
  description           String?
  category              String?   // "Combat", "Training", "Transport", "Garrison", etc
  tagsJson              String?   // Comma-separated tags for filtering
  
  // Full ORBAT structure as JSON
  slotsJson             Json      // [{name, orderIndex, subslots: [{name, orderIndex, maxSignups}]}]
  frequencyIds          Int[]     // Array of RadioFrequency IDs
  
  // Optional faction/intel defaults
  bluforCountry         String?
  bluforRelationship    String?
  opforCountry          String?
  opforRelationship     String?
  indepCountry          String?
  indepRelationship     String?
  iedThreat             String?
  civilianRelationship  String?
  rulesOfEngagement     String?
  airspace              String?
  inGameTimezone        String?
  operationDay          String?
  startTime             String?   // Default HH:MM format
  endTime               String?   // Default HH:MM format
  
  // Admin metadata
  createdBy             User      @relation(fields: [createdById], references: [id])
  createdById           Int
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  usageCount            Int       @default(0)
  isActive              Boolean   @default(true)
}

enum TrainingRequestStatus {
  pending
  approved
  rejected
  completed
}

model Training {
  id                Int                @id @default(autoincrement())
  name              String
  description       String?
  category          TrainingCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId        Int?               // Foreign key to TrainingCategory
  duration          Int?               // Duration in minutes
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userTrainings     UserTraining[]
  trainingRequests  TrainingRequest[]
}

model TrainingCategory {
  id        Int         @id @default(autoincrement())
  name      String      @unique
  orderIndex Int        @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  trainings Training[]
}

model UserTraining {
  id              Int       @id @default(autoincrement())
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  training        Training  @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  trainingId      Int
  completedAt     DateTime  @default(now())
  needsRetraining Boolean   @default(false) // Flag to indicate retraining is needed
  isHidden        Boolean   @default(false) // Admin can hide this training from user view
  notes           String?   // Admin notes about completion
  assignedAt      DateTime  @default(now())

  @@unique([userId, trainingId])
  @@index([userId])
  @@index([trainingId])
}

model TrainingRequest {
  id              Int                   @id @default(autoincrement())
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  training        Training              @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  trainingId      Int
  status          TrainingRequestStatus @default(pending)
  requestMessage  String?               // User's message/reason for requesting
  adminResponse   String?               // Admin's response or notes
  handledByAdmin  User?                 @relation("TrainingRequestHandledBy", fields: [handledByAdminId], references: [id])
  handledByAdminId Int?
  requestedAt     DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([userId])
  @@index([trainingId])
  @@index([status])
  @@index([handledByAdminId])
}
